# SÆ¡ Äá»“ Luá»“ng Há»‡ Thá»‘ng
# Ná»n Táº£ng Chatbot AI Äa Tenant

**PhiÃªn báº£n:** 1.0
**Cáº­p nháº­t láº§n cuá»‘i:** ThÃ¡ng 12/2025

---

## Má»¥c Lá»¥c
1. [Luá»“ng ÄÄƒng Nháº­p (Login Flow)](#1-luá»“ng-Ä‘Äƒng-nháº­p-login-flow)
2. [Luá»“ng Chat End-to-End](#2-luá»“ng-chat-end-to-end)
3. [Luá»“ng PhÃ¢n Quyá»n (Authorization Flow)](#3-luá»“ng-phÃ¢n-quyá»n-authorization-flow)
4. [Luá»“ng Escalation](#4-luá»“ng-escalation)
5. [Luá»“ng RAG (Knowledge Base Search)](#5-luá»“ng-rag-knowledge-base-search)
6. [Luá»“ng Tool Execution](#6-luá»“ng-tool-execution)
7. [Luá»“ng Táº¡o Tenant Má»›i](#7-luá»“ng-táº¡o-tenant-má»›i)

---

## 1. Luá»“ng ÄÄƒng Nháº­p (Login Flow)

### 1.1 SÆ¡ Äá»“ Tá»•ng Quan

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚                                           â”‚ Server  â”‚
â”‚ Browser â”‚                                           â”‚ Backend â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                      â”‚
     â”‚ [1] Má»Ÿ trang login /login                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚                                                      â”‚
     â”‚ [2] Tráº£ vá» LoginPage.tsx                            â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                      â”‚
     â”‚ [3] User nháº­p:                                      â”‚
     â”‚     - email: admin@example.com                      â”‚
     â”‚     - password: ********                            â”‚
     â”‚     - (optional) tenant_id                          â”‚
     â”‚                                                      â”‚
     â”‚ [4] POST /api/auth/login                            â”‚
     â”‚     {                                                â”‚
     â”‚       "email": "admin@example.com",                 â”‚
     â”‚       "password": "password123"                     â”‚
     â”‚     }                                                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚                                                      â”‚
     â”‚                        [5] TÃ¬m user trong DB         â”‚
     â”‚                            SELECT * FROM users       â”‚
     â”‚                            WHERE email = ?           â”‚
     â”‚                                                      â”‚
     â”‚                        [6] Verify password           â”‚
     â”‚                            bcrypt.verify(            â”‚
     â”‚                              input_password,         â”‚
     â”‚                              user.password_hash      â”‚
     â”‚                            )                         â”‚
     â”‚                                                      â”‚
     â”‚                        [7] Náº¿u sai â†’ 401 Unauthorizedâ”‚
     â”‚                        [8] Náº¿u Ä‘Ãºng â†’ Táº¡o JWT       â”‚
     â”‚                                                      â”‚
     â”‚                            Payload:                  â”‚
     â”‚                            {                         â”‚
     â”‚                              "sub": user_id,         â”‚
     â”‚                              "roles": ["admin"],     â”‚
     â”‚                              "tenant_id": "uuid",    â”‚
     â”‚                              "exp": now + 24h        â”‚
     â”‚                            }                         â”‚
     â”‚                                                      â”‚
     â”‚                            Sign vá»›i RS256            â”‚
     â”‚                            (private key)             â”‚
     â”‚                                                      â”‚
     â”‚ [9] Response                                         â”‚
     â”‚     {                                                â”‚
     â”‚       "user_id": "...",                              â”‚
     â”‚       "email": "admin@example.com",                  â”‚
     â”‚       "role": "admin",                               â”‚
     â”‚       "tenant_id": "...",                            â”‚
     â”‚       "token": "eyJhbGciOi..."                       â”‚
     â”‚     }                                                â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                      â”‚
     â”‚ [10] LÆ°u vÃ o localStorage:                          â”‚
     â”‚      localStorage.setItem('token', token)           â”‚
     â”‚      localStorage.setItem('user', JSON.stringify(user))
     â”‚                                                      â”‚
     â”‚ [11] Redirect theo role:                            â”‚
     â”‚      - admin â†’ /admin/dashboard                     â”‚
     â”‚      - supporter â†’ /support                         â”‚
     â”‚      - tenant_user â†’ /chat                          â”‚
     â”‚                                                      â”‚
     â–¼                                                      â”‚
```

### 1.2 Chi Tiáº¿t CÃ¡c BÆ°á»›c

#### BÆ°á»›c 1-3: Hiá»ƒn thá»‹ Form Login
```typescript
// frontend/src/pages/LoginPage.tsx
const LoginPage = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    const result = await authService.login({ email, password });
    // ...
  };
};
```

#### BÆ°á»›c 4-6: XÃ¡c Thá»±c Backend
```python
# backend/src/api/auth.py
@router.post("/login")
async def login(request: LoginRequest, db: Session):
    # [5] TÃ¬m user
    user = db.query(User).filter(User.email == request.email).first()
    if not user:
        raise HTTPException(401, "Invalid credentials")

    # [6] Verify password
    if not bcrypt.checkpw(request.password.encode(), user.password_hash):
        raise HTTPException(401, "Invalid credentials")

    # [8] Táº¡o JWT
    payload = {
        "sub": str(user.user_id),
        "roles": [user.role],
        "tenant_id": str(user.tenant_id),
        "exp": datetime.utcnow() + timedelta(days=1)
    }
    token = jwt.encode(payload, PRIVATE_KEY, algorithm="RS256")

    return LoginResponse(
        user_id=user.user_id,
        email=user.email,
        role=user.role,
        tenant_id=user.tenant_id,
        token=token
    )
```

#### BÆ°á»›c 10-11: LÆ°u Token & Redirect
```typescript
// frontend/src/services/authService.ts
const login = async (credentials) => {
  const response = await api.post('/api/auth/login', credentials);

  // LÆ°u token vÃ  user info
  localStorage.setItem('token', response.data.token);
  localStorage.setItem('user', JSON.stringify(response.data));

  // Redirect theo role
  if (response.data.role === 'admin') {
    navigate('/admin/dashboard');
  } else if (response.data.role === 'supporter') {
    navigate('/support');
  } else {
    navigate('/chat');
  }
};
```

### 1.3 Luá»“ng Logout

```
User clicks "Logout"
    â†“
Frontend:
  â”œâ”€ localStorage.removeItem('token')
  â”œâ”€ localStorage.removeItem('user')
  â”œâ”€ Clear React state
  â””â”€ Navigate to /login
```

---

## 2. Luá»“ng Chat End-to-End

### 2.1 SÆ¡ Äá»“ Chi Tiáº¿t

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Customerâ”‚                                                  â”‚ Backend â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                                                            â”‚
    â”‚ [1] Má»Ÿ widget â†’ ChatWidget.tsx loads                      â”‚
    â”‚     â”œâ”€ Create or retrieve session_id                      â”‚
    â”‚     â”œâ”€ Display welcome message                            â”‚
    â”‚     â””â”€ Show message input                                 â”‚
    â”‚                                                            â”‚
    â”‚ [2] GET /api/{tenant_id}/session?user_id=xxx              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚                                                            â”‚
    â”‚                   [3] Query DB:                            â”‚
    â”‚                       SELECT * FROM chat_sessions          â”‚
    â”‚                       WHERE user_id = ? AND tenant_id = ?  â”‚
    â”‚                       ORDER BY created_at DESC LIMIT 1     â”‚
    â”‚                                                            â”‚
    â”‚                   [4] Náº¿u khÃ´ng cÃ³ â†’ táº¡o má»›i:              â”‚
    â”‚                       INSERT INTO chat_sessions            â”‚
    â”‚                       Náº¿u cÃ³ â†’ return existing             â”‚
    â”‚                                                            â”‚
    â”‚ [5] Response { session_id, messages: [...] }              â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                            â”‚
    â”‚ [6] User gÃµ: "TÃ´i muá»‘n kiá»ƒm tra sá»‘ dÆ° tÃ i khoáº£n"          â”‚
    â”‚     Click Send                                             â”‚
    â”‚                                                            â”‚
    â”‚ [7] POST /api/{tenant_id}/chat                            â”‚
    â”‚     Headers: { Authorization: Bearer <token> }            â”‚
    â”‚     Body: {                                                â”‚
    â”‚       session_id: "abc-123",                              â”‚
    â”‚       message: "TÃ´i muá»‘n kiá»ƒm tra sá»‘ dÆ° tÃ i khoáº£n",       â”‚
    â”‚       user_id: "user-xyz"                                 â”‚
    â”‚     }                                                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚                                                            â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚                   â”‚ [8] MIDDLEWARE LAYER                â”‚ â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚                   â”‚ a) JWT Verification                 â”‚ â”‚
    â”‚                   â”‚    - Verify signature (public key)  â”‚ â”‚
    â”‚                   â”‚    - Check expiration               â”‚ â”‚
    â”‚                   â”‚    - Extract payload                â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ b) Tenant Isolation                 â”‚ â”‚
    â”‚                   â”‚    - Verify tenant_id from JWT      â”‚ â”‚
    â”‚                   â”‚    - Match vá»›i tenant_id trong URL  â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ c) Logging                          â”‚ â”‚
    â”‚                   â”‚    - Assign unique request_id       â”‚ â”‚
    â”‚                   â”‚    - Log request details            â”‚ â”‚
    â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                            â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚                   â”‚ [9] SUPERVISOR AGENT                â”‚ â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚                   â”‚ a) Load agents tá»« cache/DB:         â”‚ â”‚
    â”‚                   â”‚    - DebtAgent                      â”‚ â”‚
    â”‚                   â”‚    - ShipmentAgent                  â”‚ â”‚
    â”‚                   â”‚    - GuidelineAgent                 â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ b) Call LLM Ä‘á»ƒ classify intent:     â”‚ â”‚
    â”‚                   â”‚    Prompt:                          â”‚ â”‚
    â”‚                   â”‚    "User: TÃ´i muá»‘n kiá»ƒm tra sá»‘ dÆ°"  â”‚ â”‚
    â”‚                   â”‚    "Available agents: [...]"        â”‚ â”‚
    â”‚                   â”‚    "Classify intent"                â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ c) LLM Response:                    â”‚ â”‚
    â”‚                   â”‚    {                                â”‚ â”‚
    â”‚                   â”‚      "agent": "DebtAgent",          â”‚ â”‚
    â”‚                   â”‚      "intent": "SINGLE_INTENT",     â”‚ â”‚
    â”‚                   â”‚      "confidence": 0.95             â”‚ â”‚
    â”‚                   â”‚    }                                â”‚ â”‚
    â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                            â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚                   â”‚ [10] DOMAIN AGENT (DebtAgent)       â”‚ â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚                   â”‚ a) Load agent config:               â”‚ â”‚
    â”‚                   â”‚    - prompt_template                â”‚ â”‚
    â”‚                   â”‚    - llm_model_id                   â”‚ â”‚
    â”‚                   â”‚    - tools (RAG_TOOL, HTTP_TOOL)    â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ b) Entity Extraction (LLM):         â”‚ â”‚
    â”‚                   â”‚    Extract: { account_number: null }â”‚ â”‚
    â”‚                   â”‚    (User chÆ°a cung cáº¥p sá»‘ tÃ i khoáº£n)â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ c) Select tools by priority:        â”‚ â”‚
    â”‚                   â”‚    1. RAG_TOOL (priority 1)         â”‚ â”‚
    â”‚                   â”‚    2. HTTP_TOOL (priority 2)        â”‚ â”‚
    â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                            â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚                   â”‚ [11] TOOL EXECUTION                 â”‚ â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚                   â”‚ RAG_TOOL:                           â”‚ â”‚
    â”‚                   â”‚ â”œâ”€ Query: "kiá»ƒm tra sá»‘ dÆ°"          â”‚ â”‚
    â”‚                   â”‚ â”œâ”€ Generate embedding (384-dim)     â”‚ â”‚
    â”‚                   â”‚ â”œâ”€ Search pgvector:                 â”‚ â”‚
    â”‚                   â”‚ â”‚  SELECT content, metadata         â”‚ â”‚
    â”‚                   â”‚ â”‚  FROM vector_store                â”‚ â”‚
    â”‚                   â”‚ â”‚  WHERE metadata->>'tenant_id' = ? â”‚ â”‚
    â”‚                   â”‚ â”‚  ORDER BY embedding <=>           â”‚ â”‚
    â”‚                   â”‚ â”‚    '[0.1, 0.2, ...]' LIMIT 3      â”‚ â”‚
    â”‚                   â”‚ â”‚                                   â”‚ â”‚
    â”‚                   â”‚ â””â”€ Result:                          â”‚ â”‚
    â”‚                   â”‚    [                                â”‚ â”‚
    â”‚                   â”‚      {                              â”‚ â”‚
    â”‚                   â”‚        "content": "Äá»ƒ kiá»ƒm tra...", â”‚ â”‚
    â”‚                   â”‚        "score": 0.89                â”‚ â”‚
    â”‚                   â”‚      },                             â”‚ â”‚
    â”‚                   â”‚      ...                            â”‚ â”‚
    â”‚                   â”‚    ]                                â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ HTTP_TOOL:                          â”‚ â”‚
    â”‚                   â”‚ â”œâ”€ Skipped (chÆ°a cÃ³ account_number) â”‚ â”‚
    â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                            â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚                   â”‚ [12] RESPONSE GENERATION            â”‚ â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚                   â”‚ a) Aggregate tool results           â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ b) Call LLM vá»›i:                    â”‚ â”‚
    â”‚                   â”‚    - System prompt (DebtAgent)      â”‚ â”‚
    â”‚                   â”‚    - User message                   â”‚ â”‚
    â”‚                   â”‚    - RAG context                    â”‚ â”‚
    â”‚                   â”‚    - Conversation history (last 5)  â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ c) LLM generates:                   â”‚ â”‚
    â”‚                   â”‚    "Äá»ƒ kiá»ƒm tra sá»‘ dÆ° tÃ i khoáº£n,    â”‚ â”‚
    â”‚                   â”‚     báº¡n cáº§n cung cáº¥p mÃ£ tÃ i khoáº£n.  â”‚ â”‚
    â”‚                   â”‚     Báº¡n cÃ³ thá»ƒ cho tÃ´i biáº¿t mÃ£      â”‚ â”‚
    â”‚                   â”‚     tÃ i khoáº£n cá»§a báº¡n khÃ´ng?"       â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ d) Apply output format (if any)     â”‚ â”‚
    â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                            â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚                   â”‚ [13] PERSISTENCE                    â”‚ â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚                   â”‚ a) Save messages to DB:             â”‚ â”‚
    â”‚                   â”‚    INSERT INTO messages VALUES:     â”‚ â”‚
    â”‚                   â”‚    - (role: user, content: "...")   â”‚ â”‚
    â”‚                   â”‚    - (role: assistant, content:..)  â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ b) Update session:                  â”‚ â”‚
    â”‚                   â”‚    UPDATE chat_sessions SET         â”‚ â”‚
    â”‚                   â”‚    last_message_at = NOW()          â”‚ â”‚
    â”‚                   â”‚                                     â”‚ â”‚
    â”‚                   â”‚ c) Log metrics:                     â”‚ â”‚
    â”‚                   â”‚    {                                â”‚ â”‚
    â”‚                   â”‚      tokens: 280,                   â”‚ â”‚
    â”‚                   â”‚      latency_ms: 1450,              â”‚ â”‚
    â”‚                   â”‚      intent: "account_balance",     â”‚ â”‚
    â”‚                   â”‚      tools_used: ["RAG_TOOL"]       â”‚ â”‚
    â”‚                   â”‚    }                                â”‚ â”‚
    â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                            â”‚
    â”‚ [14] Response (SSE stream hoáº·c JSON)                      â”‚
    â”‚     {                                                      â”‚
    â”‚       "session_id": "abc-123",                            â”‚
    â”‚       "message": "...",                                   â”‚
    â”‚       "agent_name": "DebtAgent",                          â”‚
    â”‚       "response": "Äá»ƒ kiá»ƒm tra sá»‘ dÆ°...",                 â”‚
    â”‚       "status": "success"                                 â”‚
    â”‚     }                                                      â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                            â”‚
    â”‚ [15] Widget hiá»ƒn thá»‹ response                             â”‚
    â”‚      â”œâ”€ Parse markdown                                    â”‚
    â”‚      â”œâ”€ Add to MessageList                                â”‚
    â”‚      â””â”€ Show "Escalate" button                            â”‚
    â”‚                                                            â”‚
    â–¼                                                            â”‚
```

### 2.2 Multi-Turn Conversation

```
Turn 1:
User: "TÃ´i muá»‘n kiá»ƒm tra sá»‘ dÆ°"
Agent: "Báº¡n vui lÃ²ng cung cáº¥p mÃ£ tÃ i khoáº£n"
    â†“
Turn 2:
User: "MÃ£ tÃ i khoáº£n cá»§a tÃ´i lÃ  12345"
    â†“
Agent:
  â”œâ”€ Extract entity: { account_number: "12345" }
  â”œâ”€ Execute HTTP_TOOL vá»›i account_number
  â”œâ”€ Get data: { balance: 5000000, currency: "VND" }
  â””â”€ Response: "Sá»‘ dÆ° tÃ i khoáº£n 12345 lÃ  5.000.000 VNÄ"
```

---

## 3. Luá»“ng PhÃ¢n Quyá»n (Authorization Flow)

### 3.1 Role-Based Access Control

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REQUEST INCOMING                          â”‚
â”‚  GET /api/admin/agents                                       â”‚
â”‚  Headers: { Authorization: Bearer <JWT> }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               JWT MIDDLEWARE                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  1. Extract token from header                     â”‚      â”‚
â”‚  â”‚     token = header.split("Bearer ")[1]            â”‚      â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  2. Verify signature                              â”‚      â”‚
â”‚  â”‚     jwt.decode(token, PUBLIC_KEY, algorithms=["RS256"])
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  3. Check expiration                              â”‚      â”‚
â”‚  â”‚     if payload["exp"] < now():                    â”‚      â”‚
â”‚  â”‚       raise HTTPException(401, "Token expired")   â”‚      â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  4. Extract claims                                â”‚      â”‚
â”‚  â”‚     user_id = payload["sub"]                      â”‚      â”‚
â”‚  â”‚     roles = payload["roles"]                      â”‚      â”‚
â”‚  â”‚     tenant_id = payload["tenant_id"]              â”‚      â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  5. Attach to request                             â”‚      â”‚
â”‚  â”‚     request.state.user_id = user_id               â”‚      â”‚
â”‚  â”‚     request.state.roles = roles                   â”‚      â”‚
â”‚  â”‚     request.state.tenant_id = tenant_id           â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             AUTHORIZATION CHECK                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Route: /api/admin/agents                         â”‚      â”‚
â”‚  â”‚  Required role: "admin"                           â”‚      â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  Check:                                            â”‚      â”‚
â”‚  â”‚  if "admin" not in request.state.roles:           â”‚      â”‚
â”‚  â”‚    raise HTTPException(403, "Forbidden")          â”‚      â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  âœ… Passed â†’ Continue to handler                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             TENANT ISOLATION CHECK                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  For routes with {tenant_id} parameter:           â”‚      â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  if path_tenant_id != request.state.tenant_id:    â”‚      â”‚
â”‚  â”‚    raise HTTPException(403, "Tenant access denied")â”‚     â”‚
â”‚  â”‚                                                    â”‚      â”‚
â”‚  â”‚  âœ… Passed â†’ Continue                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ROUTE HANDLER EXECUTION                       â”‚
â”‚  Execute business logic with tenant-scoped queries           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Ma Tráº­n PhÃ¢n Quyá»n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Endpoint     â”‚ Admin  â”‚ Supporter â”‚ Tenant User â”‚ Chat User â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /api/admin/* â”‚   âœ…   â”‚    âŒ     â”‚     âŒ      â”‚    âŒ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /api/        â”‚   âœ…   â”‚    âœ…     â”‚     âœ…      â”‚    âŒ     â”‚
â”‚ {tenant}/    â”‚        â”‚           â”‚             â”‚           â”‚
â”‚ supporter/*  â”‚        â”‚           â”‚             â”‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /api/        â”‚   âœ…   â”‚    âœ…     â”‚     âœ…      â”‚    âœ…     â”‚
â”‚ {tenant}/    â”‚        â”‚(assigned) â”‚  (own only) â”‚ (own only)â”‚
â”‚ chat         â”‚        â”‚           â”‚             â”‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /api/admin/  â”‚   âœ…   â”‚    âŒ     â”‚     âŒ      â”‚    âŒ     â”‚
â”‚ tenants      â”‚        â”‚           â”‚             â”‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /api/admin/  â”‚   âœ…   â”‚    âŒ     â”‚     ğŸŸ¡      â”‚    âŒ     â”‚
â”‚ knowledge    â”‚        â”‚           â”‚  (own tenant)â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Tenant-Specific Permissions

```
Khi Agent Ä‘Æ°á»£c gá»i:
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check TenantAgentPermission             â”‚
â”‚                                         â”‚
â”‚ SELECT enabled FROM                     â”‚
â”‚ tenant_agent_permissions                â”‚
â”‚ WHERE tenant_id = ? AND agent_id = ?    â”‚
â”‚                                         â”‚
â”‚ if NOT enabled:                         â”‚
â”‚   â†’ Return error: "Agent not available" â”‚
â”‚                                         â”‚
â”‚ if enabled:                             â”‚
â”‚   â†’ Continue vá»›i agent execution        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check TenantToolPermission              â”‚
â”‚                                         â”‚
â”‚ For each tool in agent.tools:           â”‚
â”‚   SELECT enabled FROM                   â”‚
â”‚   tenant_tool_permissions               â”‚
â”‚   WHERE tenant_id = ? AND tool_id = ?   â”‚
â”‚                                         â”‚
â”‚   if NOT enabled:                       â”‚
â”‚     â†’ Skip tool                         â”‚
â”‚                                         â”‚
â”‚   if enabled:                           â”‚
â”‚     â†’ Execute tool                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Luá»“ng Escalation

### 4.1 SÆ¡ Äá»“ Escalation HoÃ n Chá»‰nh

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Customer â”‚              â”‚ Backend â”‚              â”‚ Supporter â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                        â”‚                         â”‚
     â”‚ [1] Chat vá»›i agent     â”‚                         â”‚
     â”‚     khÃ´ng giáº£i quyáº¿t   â”‚                         â”‚
     â”‚     Ä‘Æ°á»£c váº¥n Ä‘á»        â”‚                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [2] Click "Talk to     â”‚                         â”‚
     â”‚     Human" button      â”‚                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [3] POST /api/         â”‚                         â”‚
     â”‚     {tenant}/          â”‚                         â”‚
     â”‚     chat/escalate      â”‚                         â”‚
     â”‚     {                  â”‚                         â”‚
     â”‚       session_id,      â”‚                         â”‚
     â”‚       reason: "..."    â”‚                         â”‚
     â”‚     }                  â”‚                         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [4] Update DB:          â”‚
     â”‚                        â”‚     UPDATE chat_sessionsâ”‚
     â”‚                        â”‚     SET escalation_     â”‚
     â”‚                        â”‚     status = 'pending'  â”‚
     â”‚                        â”‚     WHERE session_id=?  â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [5] Broadcast SSE       â”‚
     â”‚                        â”‚     event to all        â”‚
     â”‚                        â”‚     supporters          â”‚
     â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                        â”‚                         â”‚
     â”‚ [6] Response           â”‚                         â”‚
     â”‚     {                  â”‚                         â”‚
     â”‚       success: true,   â”‚                         â”‚
     â”‚       escalation_      â”‚                         â”‚
     â”‚       status: "pending"â”‚                         â”‚
     â”‚     }                  â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [7] Widget hiá»ƒn thá»‹    â”‚                         â”‚
     â”‚     "Äang káº¿t ná»‘i      â”‚                         â”‚
     â”‚     vá»›i nhÃ¢n viÃªn..."  â”‚                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚         [8] Supporter   â”‚
     â”‚                        â”‚             tháº¥y noti   â”‚
     â”‚                        â”‚             trong queue â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚         [9] Click       â”‚
     â”‚                        â”‚             "Accept"    â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [10] POST /api/         â”‚
     â”‚                        â”‚      {tenant}/          â”‚
     â”‚                        â”‚      supporter/assign   â”‚
     â”‚                        â”‚      {                  â”‚
     â”‚                        â”‚        session_id,      â”‚
     â”‚                        â”‚        supporter_id     â”‚
     â”‚                        â”‚      }                  â”‚
     â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [11] Update DB:         â”‚
     â”‚                        â”‚      UPDATE             â”‚
     â”‚                        â”‚      chat_sessions SET  â”‚
     â”‚                        â”‚      escalation_status  â”‚
     â”‚                        â”‚      = 'assigned',      â”‚
     â”‚                        â”‚      assigned_user_id   â”‚
     â”‚                        â”‚      = supporter_id     â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [12] Notify customer    â”‚
     â”‚ [13] Widget hiá»ƒn thá»‹   â”‚     via SSE             â”‚
     â”‚      "NhÃ¢n viÃªn X      â”‚                         â”‚
     â”‚      Ä‘Ã£ tham gia"      â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
     â”‚ â”‚ [14] LIVE CHAT PHASE â”‚                      â”‚  â”‚
     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [15] User gÃµ tin nháº¯n  â”‚                         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚                        â”‚ [16] Save message       â”‚
     â”‚                        â”‚      (role: user)       â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [17] SSE broadcast      â”‚
     â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚         [18] Supporter  â”‚
     â”‚                        â”‚              gÃµ reply   â”‚
     â”‚                        â”‚ [19] POST /api/         â”‚
     â”‚                        â”‚      {tenant}/supporter â”‚
     â”‚                        â”‚      /message           â”‚
     â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [20] Save message       â”‚
     â”‚                        â”‚      (role: supporter)  â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [21] SSE broadcast     â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [22] Widget hiá»ƒn thá»‹   â”‚                         â”‚
     â”‚      tin nháº¯n supporterâ”‚                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚      ... chat tiáº¿p ... â”‚                         â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚         [23] Supporter  â”‚
     â”‚                        â”‚              click      â”‚
     â”‚                        â”‚              "Resolve"  â”‚
     â”‚                        â”‚                         â”‚
     â”‚                        â”‚ [24] UPDATE             â”‚
     â”‚                        â”‚      escalation_status  â”‚
     â”‚                        â”‚      = 'resolved'       â”‚
     â”‚                        â”‚                         â”‚
     â”‚ [25] ThÃ´ng bÃ¡o         â”‚                         â”‚
     â”‚      "PhiÃªn Ä‘Ã£ káº¿t     â”‚                         â”‚
     â”‚      thÃºc. Cáº£m Æ¡n!"    â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                        â”‚                         â”‚
     â–¼                        â–¼                         â–¼
```

### 4.2 Auto-Escalation Triggers

```
Trong quÃ¡ trÃ¬nh xá»­ lÃ½ agent:
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Auto-Escalation Conditions:       â”‚
â”‚                                         â”‚
â”‚ 1. Keyword Detection:                   â”‚
â”‚    if "nhÃ¢n viÃªn" in user_message or    â”‚
â”‚       "tÆ° váº¥n viÃªn" in user_message:    â”‚
â”‚      â†’ Trigger escalation               â”‚
â”‚                                         â”‚
â”‚ 2. Agent Unable to Handle:              â”‚
â”‚    if agent_confidence < 0.5:           â”‚
â”‚      â†’ Trigger escalation               â”‚
â”‚                                         â”‚
â”‚ 3. Tool Execution Failed:               â”‚
â”‚    if all_tools_failed:                 â”‚
â”‚      â†’ Trigger escalation               â”‚
â”‚                                         â”‚
â”‚ 4. User Frustration Detection:          â”‚
â”‚    if sentiment_score < -0.7:           â”‚
â”‚      â†’ Trigger escalation               â”‚
â”‚                                         â”‚
â”‚ 5. Complex Query:                       â”‚
â”‚    if query_complexity > threshold:     â”‚
â”‚      â†’ Offer escalation option          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Luá»“ng RAG (Knowledge Base Search)

### 5.1 Document Upload & Indexing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin  â”‚                                           â”‚ Backend â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                      â”‚
     â”‚ [1] Upload PDF/DOCX file                            â”‚
     â”‚     POST /api/admin/knowledge/upload                â”‚
     â”‚     Form-Data: {                                    â”‚
     â”‚       file: <binary>,                               â”‚
     â”‚       tenant_id: "...",                             â”‚
     â”‚       metadata: { source: "manual", ... }           â”‚
     â”‚     }                                                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚                                                      â”‚
     â”‚                        [2] Extract Text:             â”‚
     â”‚                            if PDF:                   â”‚
     â”‚                              pypdf.PdfReader()       â”‚
     â”‚                            if DOCX:                  â”‚
     â”‚                              python-docx.Document()  â”‚
     â”‚                                                      â”‚
     â”‚                        [3] Split into Chunks:        â”‚
     â”‚                            RecursiveCharacterText    â”‚
     â”‚                            Splitter(                 â”‚
     â”‚                              chunk_size=1000,        â”‚
     â”‚                              chunk_overlap=200       â”‚
     â”‚                            )                         â”‚
     â”‚                            â†’ [chunk1, chunk2, ...]   â”‚
     â”‚                                                      â”‚
     â”‚                        [4] Generate Embeddings:      â”‚
     â”‚                            For each chunk:           â”‚
     â”‚                              embedding = model.      â”‚
     â”‚                              encode(chunk_text)      â”‚
     â”‚                              â†’ [0.12, -0.34, ...]    â”‚
     â”‚                              (384 dimensions)        â”‚
     â”‚                                                      â”‚
     â”‚                        [5] Store in pgvector:        â”‚
     â”‚                            INSERT INTO vector_store  â”‚
     â”‚                            (                         â”‚
     â”‚                              id,                     â”‚
     â”‚                              content,                â”‚
     â”‚                              embedding,              â”‚
     â”‚                              metadata                â”‚
     â”‚                            ) VALUES (                â”‚
     â”‚                              uuid(),                 â”‚
     â”‚                              chunk_text,             â”‚
     â”‚                              embedding_vector,       â”‚
     â”‚                              {                       â”‚
     â”‚                                tenant_id: "...",     â”‚
     â”‚                                source: "manual",     â”‚
     â”‚                                created_at: now()     â”‚
     â”‚                              }                       â”‚
     â”‚                            )                         â”‚
     â”‚                                                      â”‚
     â”‚ [6] Response                                         â”‚
     â”‚     {                                                â”‚
     â”‚       document_id: "...",                            â”‚
     â”‚       chunks_created: 15,                            â”‚
     â”‚       status: "indexed"                              â”‚
     â”‚     }                                                â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                      â”‚
     â–¼                                                      â”‚
```

### 5.2 RAG Query Flow

```
User Message: "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ sáº£n pháº©m lÃ  gÃ¬?"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG TOOL EXECUTION                        â”‚
â”‚                                                              â”‚
â”‚  [1] Generate Query Embedding                               â”‚
â”‚      query = "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ sáº£n pháº©m"                  â”‚
â”‚      query_embedding = embedding_model.encode(query)        â”‚
â”‚      â†’ [0.15, -0.28, 0.42, ...] (384-dim vector)            â”‚
â”‚                                                              â”‚
â”‚  [2] Vector Similarity Search                               â”‚
â”‚      SQL:                                                    â”‚
â”‚      SELECT                                                  â”‚
â”‚        id,                                                   â”‚
â”‚        content,                                              â”‚
â”‚        metadata,                                             â”‚
â”‚        1 - (embedding <=> $1::vector) AS similarity          â”‚
â”‚      FROM vector_store                                       â”‚
â”‚      WHERE metadata->>'tenant_id' = $2                       â”‚
â”‚      ORDER BY embedding <=> $1::vector                       â”‚
â”‚      LIMIT 5;                                                â”‚
â”‚                                                              â”‚
â”‚      Params:                                                 â”‚
â”‚        $1 = query_embedding                                  â”‚
â”‚        $2 = tenant_id                                        â”‚
â”‚                                                              â”‚
â”‚  [3] Results                                                 â”‚
â”‚      [                                                       â”‚
â”‚        {                                                     â”‚
â”‚          content: "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£: KhÃ¡ch hÃ ng cÃ³...",   â”‚
â”‚          similarity: 0.89,                                   â”‚
â”‚          metadata: { source: "policy.pdf", page: 3 }         â”‚
â”‚        },                                                    â”‚
â”‚        {                                                     â”‚
â”‚          content: "Thá»i háº¡n Ä‘á»•i tráº£ trong vÃ²ng 30 ngÃ y...", â”‚
â”‚          similarity: 0.85,                                   â”‚
â”‚          metadata: { source: "policy.pdf", page: 4 }         â”‚
â”‚        },                                                    â”‚
â”‚        ...                                                   â”‚
â”‚      ]                                                       â”‚
â”‚                                                              â”‚
â”‚  [4] Filter by Threshold                                    â”‚
â”‚      relevant_chunks = filter(lambda x: x.similarity > 0.7) â”‚
â”‚                                                              â”‚
â”‚  [5] Return Context                                          â”‚
â”‚      context = "\n\n".join([chunk.content for chunk in      â”‚
â”‚                             relevant_chunks])                â”‚
â”‚      â†’ "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£: KhÃ¡ch hÃ ng cÃ³ thá»ƒ Ä‘á»•i tráº£..."   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Pass context to LLM for response generation
```

---

## 6. Luá»“ng Tool Execution

### 6.1 HTTP Tool Example

```
Agent cáº§n gá»i API Ä‘á»ƒ kiá»ƒm tra Ä‘Æ¡n hÃ ng
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP_TOOL EXECUTION                       â”‚
â”‚                                                              â”‚
â”‚  [1] Tool Configuration (from DB)                           â”‚
â”‚      {                                                       â”‚
â”‚        tool_id: "order-api-tool",                           â”‚
â”‚        type: "HTTP",                                         â”‚
â”‚        config: {                                             â”‚
â”‚          base_url: "https://api.example.com",               â”‚
â”‚          endpoint: "/orders/{order_id}",                    â”‚
â”‚          method: "GET",                                      â”‚
â”‚          headers: {                                          â”‚
â”‚            "Authorization": "Bearer {api_key}",             â”‚
â”‚            "Content-Type": "application/json"               â”‚
â”‚          }                                                   â”‚
â”‚        },                                                    â”‚
â”‚        input_schema: {                                       â”‚
â”‚          type: "object",                                     â”‚
â”‚          properties: {                                       â”‚
â”‚            order_id: { type: "string" }                     â”‚
â”‚          },                                                  â”‚
â”‚          required: ["order_id"]                             â”‚
â”‚        }                                                     â”‚
â”‚      }                                                       â”‚
â”‚                                                              â”‚
â”‚  [2] Validate Input                                          â”‚
â”‚      extracted_entities = { order_id: "ORD-12345" }         â”‚
â”‚      jsonschema.validate(extracted_entities, input_schema)  â”‚
â”‚      âœ… Valid                                                â”‚
â”‚                                                              â”‚
â”‚  [3] Build Request                                           â”‚
â”‚      url = base_url + endpoint.format(order_id="ORD-12345") â”‚
â”‚      â†’ "https://api.example.com/orders/ORD-12345"           â”‚
â”‚                                                              â”‚
â”‚      headers = {                                             â”‚
â”‚        "Authorization": f"Bearer {tenant.api_key}",         â”‚
â”‚        "Content-Type": "application/json"                   â”‚
â”‚      }                                                       â”‚
â”‚                                                              â”‚
â”‚  [4] Execute HTTP Call                                       â”‚
â”‚      response = requests.get(url, headers=headers,          â”‚
â”‚                               timeout=10)                    â”‚
â”‚                                                              â”‚
â”‚  [5] Handle Response                                         â”‚
â”‚      if response.status_code == 200:                        â”‚
â”‚        data = response.json()                               â”‚
â”‚        â†’ {                                                   â”‚
â”‚             order_id: "ORD-12345",                          â”‚
â”‚             status: "shipped",                              â”‚
â”‚             tracking_number: "TRACK-999",                   â”‚
â”‚             estimated_delivery: "2025-12-20"                â”‚
â”‚           }                                                  â”‚
â”‚      else:                                                   â”‚
â”‚        â†’ Error: "API returned {status_code}"                â”‚
â”‚                                                              â”‚
â”‚  [6] Return to Agent                                         â”‚
â”‚      tool_result = {                                         â”‚
â”‚        tool_name: "order-api-tool",                         â”‚
â”‚        status: "success",                                    â”‚
â”‚        data: data                                            â”‚
â”‚      }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Agent uses tool_result to generate response:
"ÄÆ¡n hÃ ng ORD-12345 cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘i vá»›i mÃ£ váº­n Ä‘Æ¡n
TRACK-999. Dá»± kiáº¿n giao hÃ ng vÃ o ngÃ y 20/12/2025."
```

---

## 7. Luá»“ng Táº¡o Tenant Má»›i

### 7.1 Tenant Setup Wizard

```
Admin muá»‘n táº¡o tenant má»›i
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Táº¡o Tenant                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/admin/tenants                                    â”‚
â”‚  {                                                           â”‚
â”‚    name: "CÃ´ng ty ABC",                                     â”‚
â”‚    domain: "abc.com",                                       â”‚
â”‚    status: "active"                                         â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  â†’ INSERT INTO tenants ...                                  â”‚
â”‚  â†’ Return tenant_id: "uuid-123"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Cáº¥u hÃ¬nh Quyá»n Agents                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PUT /api/admin/tenants/uuid-123/permissions                â”‚
â”‚  {                                                           â”‚
â”‚    agents: [                                                 â”‚
â”‚      { agent_id: "debt-agent", enabled: true },            â”‚
â”‚      { agent_id: "shipment-agent", enabled: true },        â”‚
â”‚      { agent_id: "guideline-agent", enabled: false }       â”‚
â”‚    ]                                                         â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  â†’ INSERT INTO tenant_agent_permissions ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Cáº¥u hÃ¬nh Quyá»n Tools                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PUT /api/admin/tenants/uuid-123/permissions                â”‚
â”‚  {                                                           â”‚
â”‚    tools: [                                                  â”‚
â”‚      { tool_id: "rag-tool", enabled: true },               â”‚
â”‚      { tool_id: "http-tool", enabled: true }               â”‚
â”‚    ]                                                         â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  â†’ INSERT INTO tenant_tool_permissions ...                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Táº¡o Admin User cho Tenant                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/admin/users                                      â”‚
â”‚  {                                                           â”‚
â”‚    email: "admin@abc.com",                                  â”‚
â”‚    password: "temp_password",                               â”‚
â”‚    role: "tenant_user",                                     â”‚
â”‚    tenant_id: "uuid-123"                                    â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  â†’ hash_password = bcrypt.hashpw(password)                  â”‚
â”‚  â†’ INSERT INTO users ...                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Táº£i lÃªn Knowledge Base (Optional)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tenant admin Ä‘Äƒng nháº­p vÃ  upload documents                 â”‚
â”‚  â†’ Documents Ä‘Æ°á»£c index vÃ o pgvector vá»›i tenant_id          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: TÃ¹y chá»‰nh Widget                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PUT /api/admin/widgets/uuid-123                            â”‚
â”‚  {                                                           â”‚
â”‚    primary_color: "#007bff",                                â”‚
â”‚    position: "bottom-right",                                â”‚
â”‚    welcome_message: "Xin chÃ o! TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬?",       â”‚
â”‚    logo_url: "https://abc.com/logo.png"                     â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  â†’ UPDATE widget_configs ...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Deploy Widget                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tenant nháº­n embed code:                                    â”‚
â”‚  <script>                                                    â”‚
â”‚    window.chatConfig = {                                     â”‚
â”‚      tenant_id: "uuid-123",                                 â”‚
â”‚      widget_id: "widget-xyz"                                â”‚
â”‚    };                                                        â”‚
â”‚  </script>                                                   â”‚
â”‚  <script src="https://cdn.chatbot.com/widget.js"></script>  â”‚
â”‚                                                              â”‚
â”‚  â†’ Tenant nhÃºng vÃ o website                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
âœ… Tenant setup hoÃ n táº¥t!
```

---

## Tá»•ng Káº¿t

CÃ¡c sÆ¡ Ä‘á»“ luá»“ng nÃ y minh há»a chi tiáº¿t cÃ¡ch há»‡ thá»‘ng hoáº¡t Ä‘á»™ng tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i, bao gá»“m:

âœ… **Luá»“ng ÄÄƒng nháº­p**: JWT authentication vá»›i RS256
âœ… **Luá»“ng Chat**: Tá»« user message â†’ supervisor â†’ domain agent â†’ tools â†’ response
âœ… **Luá»“ng PhÃ¢n quyá»n**: RBAC + tenant isolation
âœ… **Luá»“ng Escalation**: Auto/manual escalation â†’ supporter assignment â†’ live chat
âœ… **Luá»“ng RAG**: Document upload â†’ embedding â†’ pgvector search
âœ… **Luá»“ng Tool**: HTTP tool vá»›i validation vÃ  error handling
âœ… **Luá»“ng Setup Tenant**: End-to-end tenant onboarding

**Tráº¡ng thÃ¡i TÃ i liá»‡u:** âœ… HoÃ n thÃ nh
**NgÃ y Xem xÃ©t Tiáº¿p theo:** ThÃ¡ng 1/2026
